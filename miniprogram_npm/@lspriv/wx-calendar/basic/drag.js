"use strict";var e=this&&this.__awaiter||function(e,n,s,l){return new(s=s||Promise)(function(a,t){function i(e){try{_(l.next(e))}catch(e){t(e)}}function r(e){try{_(l.throw(e))}catch(e){t(e)}}function _(e){var t;e.done?a(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(i,r)}_((l=l.apply(e,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Dragger=exports.easingOpt=void 0;let t=require("../interface/component"),l=require("./tools"),m=require("./constants"),E=require("./layout"),i=require("./panel"),r=require("../interface/calendar"),_=require("../utils/shared"),{shared:n,timing:y,sequence:A,Easing:$,delay:f,runOnJS:V}=wx.worklet,s=60,d=8,R=280,L=220,a=(e,t=wx.worklet.Easing.out(wx.worklet.Easing.sin))=>({duration:e,easing:t});exports.easingOpt=a;class o extends t.CalendarHandler{constructor(e){super(e),this._style_ids_=new Map,this.initializeShared()}initializeShared(){var e=this._instance_,t=(e.$_drag_state=n(0),e.$_current=n(e.data.current),e.$_drag_schedule_opacity=n(0),n(E.Layout.viewHeight(e._view_)));e.$_drag_panel_height=t;let a=e.data.checked||(0,r.normalDate)(e.data.date);t=Array.from({length:m.CALENDAR_PANELS},(e,t)=>n(this.calcPanelOffset(t,a))),e.$_drag_panel_trans=n(t),e.$_drag_bar_rotate=n(0),t=n(e._view_&m.View.week?s:0);e.$_drag_view_bar_translate_=t}update(){this._instance_.$_current.value=this._instance_.data.current,this.setPanelTrans()}bindAnimations(){this.bindContainerAnimation(),this.bindPanelAnimation(),this.bindBarAnimation(),this.bindViewBarAnimation()}bindContainerAnimation(){return e(this,void 0,void 0,function*(){let e=this._instance_;var t=yield(0,l.applyAnimated)(e,m.SELECTOR.PANEL_CONTAINER,()=>{"worklet";return{height:e.$_drag_panel_height.value+"px"}});this._style_ids_.set(m.SELECTOR.PANEL_CONTAINER,t)})}bindPanelAnimation(){return e(this,void 0,void 0,function*(){let a=this._instance_,{mainHeight:i,minHeight:r,dragMax:_}=E.Layout.layout;for(let e=0;e<m.CALENDAR_PANELS;e++){var n=m.SELECTOR.PANEL+e;let t=a.$_drag_panel_trans.value[e];var s=yield(0,l.applyAnimated)(a,n,()=>{"worklet";var e=Math.min(_,Math.max(r,a.$_drag_panel_height.value));return{transform:`translateY(${-(e>=i?0:t.value*(i-e)/(i-r))}px)`}});this._style_ids_.set(n,s)}})}bindBarAnimation(){return e(this,void 0,void 0,function*(){let e=this._instance_;var[t,a]=yield(0,_.promises)([(0,l.applyAnimated)(e,m.SELECTOR.BAR_1,()=>{"worklet";return{transform:`rotate(${e.$_drag_bar_rotate.value}deg)`}}),(0,l.applyAnimated)(e,m.SELECTOR.BAR_2,()=>{"worklet";return{transform:`rotate(${-e.$_drag_bar_rotate.value}deg)`}})]);this._style_ids_.set(m.SELECTOR.BAR_1,t),this._style_ids_.set(m.SELECTOR.BAR_2,a)})}bindViewBarAnimation(){return e(this,void 0,void 0,function*(){let e=this._instance_;var[t,a,i]=yield(0,_.promises)([(0,l.applyAnimated)(e,m.SELECTOR.VIEW_BAR,()=>{"worklet";return{transform:`translateX(${e.$_drag_view_bar_translate_.value}rpx) translateZ(0px)`}}),(0,l.applyAnimated)(e,m.SELECTOR.VIEW_BAR_1,()=>{"worklet";return{width:Math.max(s-d-e.$_drag_view_bar_translate_.value,d)+"rpx"}}),(0,l.applyAnimated)(e,m.SELECTOR.VIEW_BAR_2,()=>{"worklet";return{width:Math.max(e.$_drag_view_bar_translate_.value-d,d)+"rpx"}})]);this._style_ids_.set(m.SELECTOR.VIEW_BAR,t),this._style_ids_.set(m.SELECTOR.VIEW_BAR_1,a),this._style_ids_.set(m.SELECTOR.VIEW_BAR_2,i)})}bindScheduleAnimation(){return e(this,void 0,void 0,function*(){var e=this._instance_,t=(e.$_drag_schedule_opacity.value=e._view_&m.View.schedule?1:0,this.clearScheduleAnimation(),e.data.current),t=(this._schedule_selector_=""+m.SELECTOR.PANEL+t+" "+m.SELECTOR.SCHEDULES,yield(0,l.applyAnimated)(e,this._schedule_selector_,()=>{"worklet";return{opacity:this._instance_.$_drag_schedule_opacity.value}}));this._style_ids_.set(this._schedule_selector_,t)})}clearScheduleAnimation(){var e=this._style_ids_.get(this._schedule_selector_);e&&((0,l.clearAnimated)(this._instance_,this._schedule_selector_,[e]),this._style_ids_.delete(this._schedule_selector_))}calcPanelOffset(e,t){var a=this._instance_.data,[,t]=i.PanelTool.calcPanelOffset((0,r.offsetDate)(t,7*(0,l.circularDiff)(e,a.current)),a.weekstart);return t}setPanelTrans(){let i=this._instance_;i.$_drag_panel_trans.value.forEach((e,t)=>{var a=this.calcPanelOffset(t,i.data.checked||(0,r.normalDate)(i.data.date));i.$_drag_panel_trans.value[t].value=a})}dragout(s){let l=this._instance_,{minHeight:d,maxHeight:o,mainHeight:e}=E.Layout.layout,h=l.$_drag_panel_height.value,u=d,c=n(0);var t;l._view_&m.View.week?(t=h-d,c.value=!(0<s)&&t<u?m.View.week:m.View.month):l._view_&m.View.schedule?(t=h-u,c.value=!(t>-u)||s<0?m.View.month:m.View.schedule):(t=h-e,c.value=s?0<t?0<s?m.View.schedule:m.View.month:s<0?m.View.week:m.View.month:t<-u?m.View.week:t>u?m.View.schedule:m.View.month);let v=c.value&m.View.week,g=c.value&m.View.schedule,w=v?d:g?o:e,p=(0,exports.easingOpt)(R);return new Promise(e=>{var t,a,i,r,_,n=()=>{"worklet";V(e)(c.value)};!s||(t=Math.ceil(1e3*Math.abs((w-h)/s)))>=R||h<=d||h>=o?(l.$_drag_panel_height.value=y(w,p),l.$_drag_bar_rotate.value=y(0,p,n)):(_=u-u*t/R,a=Math.floor(Math.asin(_/u)*L),i=(0,exports.easingOpt)(a),r=(0,exports.easingOpt)(t,$.bezier(0,0,1,1)),_=!v&&(g||0<s)?w+_:w-_,l.$_drag_panel_height.value=A(y(w,r,n),y(_,i),y(w,i)),l.$_drag_bar_rotate.value=f(a+t,y(0,p))),l.$_drag_view_bar_translate_.value=y(v?60:0,p),l.$_drag_schedule_opacity.value=y(g?1:0,p)})}toView(r,_=!1){let n=this._instance_;if(n._view_&r)return Promise.resolve();let{minHeight:s,maxHeight:l,mainHeight:d}=E.Layout.layout,o={duration:R,easing:$.out($.sin)};return new Promise(e=>{var t=r&m.View.week?s:r&m.View.schedule?l:d,a=r&m.View.week?60:0,i=r&m.View.schedule?1:0;n.$_drag_panel_height.value=_?y(t,o,()=>{"worklet";V(e)()}):t,n.$_drag_view_bar_translate_.value=_?y(a,o):a,n.$_drag_schedule_opacity.value=_?y(i,o):i,_||e()})}clear(){var e,t=this._instance_;for(e of[...this._style_ids_.keys()]){var a=this._style_ids_.get(e);a&&(0,l.clearAnimated)(t,e,[a])}this._style_ids_.clear(),t.$_current=void 0,t.$_drag_state=void 0,t.$_drag_panel_height=void 0,t.$_drag_panel_trans=void 0,t.$_drag_bar_rotate=void 0,t._dragger_=void 0}}exports.Dragger=o;