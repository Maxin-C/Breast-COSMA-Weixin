<!-- pages/exercise/exercise.wxml -->
<view class="container">
  <!-- 导航栏 -->
  <view class="nav-bar">
    <image class="nav-back-icon" src="../../components/images/back-arrow.svg" mode="aspectFit" bind:tap="handleHome"></image>
    <view class="nav-title">上肢康复锻炼</view>
  </view>

  <!-- 训练未开始时的界面 -->
  <block wx:if="{{!isTrainingStarted}}">
    <view class="start-screen">
      <button class="start-button" bindtap="startTraining">开始训练</button>
    </view>
  </block>

  <!-- 训练开始后的界面 -->
  <block wx:else>
    <!-- 摄像头和视频的容器 -->
    <view class="camera-video-wrapper" style="width: 100%; height: {{cameraHeight}}px;">
      <!-- 摄像头组件 -->
      <!-- 【修改】增加了 frame-size="medium" 来开启实时帧数据监听 -->
      <camera
        id="exerciseCamera"
        device-position="front"
        flash="off"
        bindstop="onCameraStop"
        binderror="onCameraError"
        frame-size="medium"
        style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: {{isCameraVisibleForUser ? 2 : 0}}; opacity: {{isCameraVisibleForUser ? 1 : 0}};"
      ></camera>

      <!-- 视频组件 -->
      <video
        id="exerciseVideo"
        class="exercise-video"
        src="{{currentVideoUrl}}"
        controls="{{false}}"
        autoplay="{{true}}"
        show-play-btn="{{false}}"
        show-fullscreen-btn="{{false}}"
        enable-play-gesture="{{false}}"
        loop="{{false}}"
        bindended="onVideoEnded"
        bindtimeupdate="onVideoTimeUpdate"
        bindplay="onVideoPlay"
        bindwaiting="onVideoWaiting"
        binderror="onVideoError"
        wx:if="{{isPositioned && !isPaused}}"
      ></video>

      <!-- 定位提示的覆盖层 -->
      <view class="camera-overlay" wx:if="{{isCameraVisibleForUser && !isPositioned}}">
        <text class="camera-prompt">请调整位置，将上半身放入摄像头范围内</text>
        <view class="guide-box"></view>
        <text class="camera-countdown">{{countdown}}s 后返回</text>
      </view>
    </view>

    <!-- 控制器容器 -->
    <view class="controls-container" wx:if="{{isPositioned}}">
      <view class="progress-bar">
        <view class="progress-indicator" style="width: {{totalProgressPercentage}}%;"></view>
      </view>
      <text class="progress-text">
        当前动作: {{currentActionName}} (已完成 {{completedDemonstrationVideos}} / 共 {{totalDemonstrationVideos}} 个动作)
      </text>

      <view class="button-group">
        <button class="control-button" bindtap="togglePause">
          {{isPaused ? '继续' : '暂停'}}
        </button>
        <button class="control-button" bindtap="skipCurrentAction">跳过动作</button>
        <button class="control-button terminate-button" bindtap="terminateTraining">终止</button>
      </view>
    </view>
  </block>

  <!-- 加载提示 -->
  <view wx:if="{{showLoading}}" class="loading-overlay">
    <text class="loading-text">加载视频中...</text>
  </view>

  <!-- 【新增】用于将实时帧数据转换为图片的隐藏canvas -->
  <canvas type="2d" id="frameCanvas"
    style="width:{{frameCanvasWidth}}px; height:{{frameCanvasHeight}}px; position:absolute; left:-9999px; top:-9999px;">
  </canvas>

  <!-- 用于雪碧图拼接的隐藏canvas -->
  <canvas type="2d" id="spriteSheetCanvas"
    style="width:{{spriteSheetCanvasWidth}}px; height:{{spriteSheetCanvasHeight}}px; position:absolute; left:-9999px; top:-9999px;">
  </canvas>
</view>