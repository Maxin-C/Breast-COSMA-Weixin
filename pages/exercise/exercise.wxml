<view class="container">
  <view class="nav-bar">
    <image class="nav-back-icon" src="../../components/images/back-arrow.svg" mode="aspectFit" bind:tap="handleHome"></image>
    <view class="nav-title">上肢康复锻炼</view>
  </view>

  <block wx:if="{{!isTrainingStarted && !isTrainingFinished}}">
    <view class="initial-screen">
      <text class="initial-message">{{initialMessage}}</text>
      <button class="start-button" bindtap="startTraining">重新开始训练</button>
    </view>
  </block>

  <block wx:if="{{!isTrainingFinished && isTrainingStarted}}">
    <view class="camera-video-wrapper" style="width: 100%; height: {{cameraHeight}}px;">
      <camera
        id="exerciseCamera"
        device-position="front"
        flash="off"
        bindstop="onCameraStop"
        binderror="onCameraError"
        frame-size="medium"
        style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: {{isCameraVisibleForUser ? 2 : 0}}; opacity: {{isCameraVisibleForUser ? 1 : 0}};"
      ></camera>

      <video
        id="exerciseVideo"
        class="exercise-video"
        src="{{currentVideoUrl}}"
        controls="{{false}}"
        autoplay="{{true}}"
        show-play-btn="{{false}}"
        show-fullscreen-btn="{{false}}"
        enable-play-gesture="{{false}}"
        loop="{{false}}"
        bindended="onVideoEnded"
        bindtimeupdate="onVideoTimeUpdate"
        bindplay="onVideoPlay"
        bindwaiting="onVideoWaiting"
        binderror="onVideoError"
        wx:if="{{isPositioned && !isPaused}}"
      ></video>

      <view class="camera-overlay" wx:if="{{isCameraVisibleForUser && !isPositioned}}">
        <text class="camera-prompt">请调整位置，将上半身放入摄像头范围内</text>
        <view class="guide-box"></view>
        <text class="camera-countdown">{{countdown}}s 后返回</text>
      </view>

      <!-- 新增：实时反馈文本显示区域 -->
      <view class="feedback-container" wx:if="{{feedbackText}}">
        <!-- <image class="feedback-icon" src="../../components/images/voice-icon.svg"></image> -->
        <text class="feedback-text">{{feedbackText}}</text>
      </view>

    </view>

    <view class="controls-container" wx:if="{{isPositioned}}">
      <view class="progress-bar">
        <view class="progress-indicator" style="width: {{totalProgressPercentage}}%;"></view>
      </view>
      <text class="progress-text">
        当前动作: {{currentActionName}} (已完成 {{completedDemonstrationVideos}} / 共 {{totalDemonstrationVideos}} 个动作)
      </text>

      <view class="button-group">
        <button class="control-button" bindtap="togglePause">
          {{isPaused ? '继续' : '暂停'}}
        </button>
        <button class="control-button" bindtap="skipCurrentAction">跳过动作</button>
        <button class="control-button terminate-button" bindtap="terminateTraining">终止</button>
      </view>
    </view>
  </block>

  <block wx:if="{{isTrainingFinished}}">
    <view class="report-container">
      <view class="report-title">训练评估报告</view>
      
      <scroll-view scroll-y class="scores-list">
        <view wx:for="{{evaluationResults}}" wx:for-item="result"  wx:key="exerciseId" class="score-item">
          <view class="action-name">{{result.actionName}}</view>
          <view class="star-rating">
            <image 
              wx:for="{{5}}" 
              wx:key="index" 
              class="star-icon" 
              src="{{result.score / 2 > index ? (result.score / 2 >= index + 1 ? '../../components/images/star-full.svg' : '../../components/images/star-half.svg') : '../../components/images/star-empty.svg'}}"
            ></image>
            <text class="score-text">{{result.score}}分</text>
          </view>
        </view>
      </scroll-view>

      <view class="summary-container">
        <view class="summary-title">综合评估</view>
        <scroll-view scroll-y class="summary-content">
          <block wx:if="{{isSummaryLoading}}">
            <view class="loading-summary">
              <view class="loading-spinner"></view>
              <text>正在生成综合报告...</text>
            </view>
          </block>
          <block wx:else>
            <text>{{summaryReport}}</text>
          </block>
        </scroll-view>
      </view>

      <view class="chat-prompt-container">
        <view class="chat-icon-wrapper" bindtap="redirectToChat">
          <image class="chat-icon" src="../../components/images/chat-bubble.svg"></image>
        </view>
        <text class="chat-prompt-text">点击咨询，了解如何根据报告进行调整</text>
      </view>
    </view>
  </block>

  <canvas type="2d" id="frameCanvas"
    style="width:{{frameCanvasWidth}}px; height:{{frameCanvasHeight}}px; position:absolute; left:-9999px; top:-9999px;">
  </canvas>

  <canvas type="2d" id="spriteSheetCanvas"
    style="width:{{spriteSheetCanvasWidth}}px; height:{{spriteSheetCanvasHeight}}px; position:absolute; left:-9999px; top:-9999px;">
  </canvas>
</view>
